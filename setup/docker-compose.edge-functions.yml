# ==============================================================================
# VideoPopup - Edge Functions Docker Setup
# ==============================================================================
# This Docker Compose file runs edge functions locally using Deno
# Use this for self-hosting edge functions without Supabase's hosted service
#
# Usage:
#   docker compose -f setup/docker-compose.edge-functions.yml up -d
# ==============================================================================

version: '3.8'

services:
  # ============================================================================
  # Get Widget Function
  # ============================================================================
  get-widget:
    image: denoland/deno:1.40.0
    container_name: vp-get-widget
    restart: unless-stopped
    working_dir: /app
    volumes:
      - ../supabase/functions/get-widget:/app:ro
    environment:
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
    command: run --allow-net --allow-env --allow-read /app/index.ts
    ports:
      - "8001:8000"
    networks:
      - videopop-net

  # ============================================================================
  # Track Analytics Function
  # ============================================================================
  track-analytics:
    image: denoland/deno:1.40.0
    container_name: vp-track-analytics
    restart: unless-stopped
    working_dir: /app
    volumes:
      - ../supabase/functions/track-analytics:/app:ro
    environment:
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
    command: run --allow-net --allow-env --allow-read /app/index.ts
    ports:
      - "8002:8000"
    networks:
      - videopop-net

  # ============================================================================
  # Embed Script Function
  # ============================================================================
  embed-script:
    image: denoland/deno:1.40.0
    container_name: vp-embed-script
    restart: unless-stopped
    working_dir: /app
    volumes:
      - ../supabase/functions/embed-script:/app:ro
    environment:
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
    command: run --allow-net --allow-env --allow-read /app/index.ts
    ports:
      - "8003:8000"
    networks:
      - videopop-net

  # ============================================================================
  # Send Lead Notification Function
  # ============================================================================
  send-lead-notification:
    image: denoland/deno:1.40.0
    container_name: vp-lead-notification
    restart: unless-stopped
    working_dir: /app
    volumes:
      - ../supabase/functions/send-lead-notification:/app:ro
    environment:
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - SMTP_PASSWORD=${SMTP_PASSWORD}
    command: run --allow-net --allow-env --allow-read /app/index.ts
    ports:
      - "8004:8000"
    networks:
      - videopop-net

  # ============================================================================
  # Nginx Reverse Proxy (Optional - routes /functions/v1/* to correct service)
  # ============================================================================
  edge-proxy:
    image: nginx:alpine
    container_name: vp-edge-proxy
    restart: unless-stopped
    volumes:
      - ./nginx-edge-functions.conf:/etc/nginx/conf.d/default.conf:ro
    ports:
      - "8080:80"
    networks:
      - videopop-net
    depends_on:
      - get-widget
      - track-analytics
      - embed-script
      - send-lead-notification

networks:
  videopop-net:
    driver: bridge
